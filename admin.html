<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin panel</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-panel {
      max-width: 1000px;
      margin: 2em auto;
      padding: 1.5em;
      background: #ffffffcc;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }
    .toggle-buttons {
      display: flex;
      gap: 1em;
      margin-bottom: 1.5em;
      justify-content: center;
    }
    .order-card, .message-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      background: #f9f9f9;
    }
    .order-card input,
    .order-card select {
      padding: 0.4em;
      width: 100%;
      margin-top: 0.3em;
      margin-bottom: 0.8em;
    }
    .save-btn, .delete-btn {
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 0.5em 1em;
      border-radius: 6px;
      cursor: pointer;
    }
    .save-btn:hover { background-color: #005fa3; }
    .delete-btn { background-color: #cc0000; margin-top: 0.5em; }
    .delete-btn:hover { background-color: #a80000; }
    .logout-btn {
      background-color: #555;
      color: white;
      padding: 0.5em 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .logout-btn:hover { background-color: #333; }
    .lang-switcher { text-align: center; margin-top: 2em; }
    .hidden { display: none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
</head>
<body>
  <div class="admin-panel">
    <div class="admin-header">
      <h2>Admin Panel</h2>
      <button class="logout-btn" onclick="logout()">Odhlásiť sa</button>
    </div>

    <div class="toggle-buttons">
      <button onclick="showSection('orders')">Objednávky</button>
      <button onclick="showSection('messages')">Správy</button>
    </div>

    <div id="ordersSection">
      <h3>Objednávky</h3>
      <button onclick="exportOrdersCSV()">Export objednávok do CSV</button>
      <div id="ordersList">Načítavam objednávky...</div>
    </div>

    <div id="messagesSection" class="hidden">
      <h3>Správy z kontaktu</h3>
      <button onclick="exportMessagesCSV()">Export správ do CSV</button>
      <div id="messagesList">Načítavam správy...</div>
    </div>

    <div class="lang-switcher">
      <button onclick="setLanguage('sk')">SK</button>
      <button onclick="setLanguage('hu')">HU</button>
      <button onclick="setLanguage('en')">EN</button>
    </div>
  </div>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = "info@akhtransport.sk";

    auth.onAuthStateChanged(user => {
      if (!user || user.email !== ADMIN_EMAIL) {
        window.location.href = "index.html";
      } else {
        loadOrders();
        loadMessages();
      }
    });

    function logout() {
      auth.signOut().then(() => window.location.href = "index.html");
    }

    function showSection(section) {
      document.getElementById("ordersSection").classList.toggle("hidden", section !== "orders");
      document.getElementById("messagesSection").classList.toggle("hidden", section !== "messages");
    }

    async function loadOrders() {
      const list = document.getElementById("ordersList");
      list.innerHTML = "";
      try {
        const snapshot = await db.collection("orders").orderBy("date", "desc").get();
        if (snapshot.empty) {
          list.innerHTML = "<p>Žiadne objednávky zatiaľ neexistujú.</p>";
          return;
        }
        snapshot.forEach(doc => {
          const data = doc.data();
          const card = document.createElement("div");
          card.className = "order-card";
          card.innerHTML = `
            <p><strong>Vyzdvihnutie:</strong> ${data.pickup || "-"}</p>
            <p><strong>Doručenie:</strong> ${data.delivery || "-"}</p>
            <p><strong>Dátum:</strong> ${data.date || "-"}</p>
            <p><strong>Poznámka:</strong> ${data.note || "-"}</p>
            <p><strong>Email zákazníka:</strong> ${data.email || "-"}</p>
            <label>Stav:</label>
            <select id="status-${doc.id}">
              <option value="Čaká" ${data.status === "Čaká" ? "selected" : ""}>Čaká</option>
              <option value="Vybavuje sa" ${data.status === "Vybavuje sa" ? "selected" : ""}>Vybavuje sa</option>
              <option value="Doručené" ${data.status === "Doručené" ? "selected" : ""}>Doručené</option>
            </select>
            <label>Cena (€):</label>
            <input type="number" id="price-${doc.id}" value="${data.price || ""}" />
            <button class="save-btn" onclick="saveOrder('${doc.id}')">Uložiť zmeny</button>
          `;
          list.appendChild(card);
        });
      } catch (err) {
        list.innerHTML = "<p>Chyba pri načítaní objednávok.</p>";
      }
    }

    async function saveOrder(id) {
      const status = document.getElementById("status-" + id).value;
      const price = document.getElementById("price-" + id).value;
      try {
        await db.collection("orders").doc(id).update({
          status,
          price: price !== "" ? parseFloat(price) : null
        });
        alert("Objednávka bola aktualizovaná.");
      } catch (err) {
        alert("Chyba pri ukladaní: " + err.message);
      }
    }

    async function loadMessages() {
      const list = document.getElementById("messagesList");
      list.innerHTML = "";
      try {
        const snapshot = await db.collection("messages").orderBy("timestamp", "desc").get();
        if (snapshot.empty) {
          list.innerHTML = "<p>Žiadne správy zatiaľ neboli prijaté.</p>";
          return;
        }
        snapshot.forEach(doc => {
          const data = doc.data();
          const card = document.createElement("div");
          card.className = "message-card";
          const date = data.timestamp?.toDate().toLocaleString() || "-";
          card.innerHTML = `
            <p><strong>Meno:</strong> ${data.name || "-"}</p>
            <p><strong>Email:</strong> ${data.email || "-"}</p>
            <p><strong>Správa:</strong><br/> ${data.message || "-"}</p>
            <p><strong>Dátum:</strong> ${date}</p>
            <button class="delete-btn" onclick="deleteMessage('${doc.id}')">Vymazať</button>
          `;
          list.appendChild(card);
        });
      } catch (err) {
        list.innerHTML = "<p>Chyba pri načítaní správ.</p>";
      }
    }

    async function deleteMessage(id) {
      if (confirm("Naozaj chcete vymazať túto správu?")) {
        try {
          await db.collection("messages").doc(id).delete();
          loadMessages();
        } catch (err) {
          alert("Chyba pri mazaní: " + err.message);
        }
      }
    }

    function downloadCSV(filename, rows) {
      const processRow = (row) => row.map(String).map(v => `"${v.replace(/"/g, '""')}"`).join(",");
      const csvContent = [processRow(Object.keys(rows[0])), ...rows.map(processRow)].join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    async function exportOrdersCSV() {
      try {
        const snapshot = await db.collection("orders").get();
        const data = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          data.push({
            Vyzdvihnutie: d.pickup || "",
            Doručenie: d.delivery || "",
            Dátum: d.date || "",
            Email: d.email || "",
            Poznámka: d.note || "",
            Stav: d.status || "",
            Cena: d.price || ""
          });
        });
        if (data.length) downloadCSV("objednavky.csv", data);
        else alert("Žiadne objednávky na export.");
      } catch (err) {
        alert("Chyba pri exporte objednávok: " + err.message);
      }
    }

    async function exportMessagesCSV() {
      try {
        const snapshot = await db.collection("messages").get();
        const data = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          data.push({
            Meno: d.name || "",
            Email: d.email || "",
            Správa: d.message || "",
            Dátum: d.timestamp?.toDate().toLocaleString() || ""
          });
        });
        if (data.length) downloadCSV("spravy.csv", data);
        else alert("Žiadne správy na export.");
      } catch (err) {
        alert("Chyba pri exporte správ: " + err.message);
      }
    }
  </script>

  <script src="lang.js"></script>
</body>
</html>
